{% extends 'base.html' %}
{% block content %}

<h3 class="mb-3">
  {{ "Edit Purchase" if purchase else "New Purchase" }}
</h3>

<form method="post" class="card shadow-sm p-3">

<div class="row g-3">

<div class="col-md-3">
<label class="form-label">Date</label>
<input type="date"
       name="date"
       class="form-control"
       value="{{ purchase.date if purchase else '' }}"
       required>
</div>

<div class="col-md-6">
<label class="form-label">Vendor</label>
<div class="d-flex gap-2">

<select name="vendor_id" class="form-select">
<option value="">Select Vendor</option>
{% for c in clients %}
<option value="{{ c.id }}"
  {% if purchase and purchase.vendor_name == c.name %}selected{% endif %}>
  {{ c.name }}
</option>
{% endfor %}
</select>

<input type="text"
       name="vendor_name"
       class="form-control"
       value="{{ purchase.vendor_name if purchase else '' }}"
       placeholder="Or type vendor name">

</div>
</div>

<div class="col-md-3">
<label class="form-label">Freight</label>
<input type="number"
       step="0.01"
       name="freight"
       id="freight"
       class="form-control"
       value="{{ purchase.freight if purchase else 0 }}">
</div>

<div class="col-md-3">
<label class="form-label">GST %</label>
<select name="gst_percent" id="gst_percent" class="form-select">
  {% for g in [0,4,12,18] %}
  <option value="{{ g }}"
    {% if purchase and purchase.gst_percent == g %}selected{% endif %}>
    {{ g }}%
  </option>
  {% endfor %}
</select>
</div>

<div class="col-12">
<label class="form-label">Line Items</label>

<table class="table table-sm align-middle">
<thead>
<tr>
<th>Quantity (kg)</th>
<th>Rate ₹/kg</th>
<th width="80"></th>
</tr>
</thead>

<tbody id="items-body">

{% if purchase and purchase.items %}
{% for item in purchase.items %}
<tr class="item-row">
<td>
<input type="number" step="0.01"
       name="quantity[]"
       class="form-control qty"
       value="{{ item.quantity_kg }}"
       required>
</td>
<td>
<input type="number" step="0.01"
       name="rate[]"
       class="form-control rate"
       value="{{ item.rate_per_kg }}"
       required>
</td>
<td>
<button type="button" class="btn btn-sm btn-danger remove-row">−</button>
</td>
</tr>
{% endfor %}
{% else %}
<tr class="item-row">
<td><input type="number" step="0.01" name="quantity[]" class="form-control qty" required></td>
<td><input type="number" step="0.01" name="rate[]" class="form-control rate" required></td>
<td><button type="button" class="btn btn-sm btn-danger remove-row">−</button></td>
</tr>
{% endif %}

</tbody>
</table>

<button type="button" id="add-row" class="btn btn-sm btn-secondary">+ Add Row</button>
</div>

<!-- GST SUMMARY -->
<div class="col-12 mt-3">
<div class="card bg-light p-3">

<div class="d-flex justify-content-between">
<span>Subtotal</span>
<span>₹ <span id="subtotal">0.00</span></span>
</div>

<div class="d-flex justify-content-between">
<span>CGST</span>
<span>₹ <span id="cgst">0.00</span></span>
</div>

<div class="d-flex justify-content-between">
<span>SGST</span>
<span>₹ <span id="sgst">0.00</span></span>
</div>

<hr>

<div class="d-flex justify-content-between">
<h5>Grand Total</h5>
<h5 class="text-primary">₹ <span id="grandTotal">0.00</span></h5>
</div>

</div>
</div>

<div class="col-12">
<button class="btn btn-primary">
{{ "Update Purchase" if purchase else "Save Purchase" }}
</button>
</div>

</div>
</form>

<script>

function calculateTotal() {

    let subtotal = 0;

    document.querySelectorAll(".item-row").forEach(row => {
        let qty = parseFloat(row.querySelector(".qty")?.value) || 0;
        let rate = parseFloat(row.querySelector(".rate")?.value) || 0;
        subtotal += qty * rate;
    });

    let freight = parseFloat(document.getElementById("freight")?.value) || 0;
    subtotal += freight;

    let gstPercent = parseFloat(document.getElementById("gst_percent")?.value) || 0;

    let gstAmount = subtotal * gstPercent / 100;

    let cgst = gstAmount / 2;
    let sgst = gstAmount / 2;

    let grandTotal = subtotal + gstAmount;

    document.getElementById("subtotal").innerText = subtotal.toFixed(2);
    document.getElementById("cgst").innerText = cgst.toFixed(2);
    document.getElementById("sgst").innerText = sgst.toFixed(2);
    document.getElementById("grandTotal").innerText = grandTotal.toFixed(2);
}

document.addEventListener("input", function(e) {
    if (
        e.target.classList.contains("qty") ||
        e.target.classList.contains("rate") ||
        e.target.id === "freight" ||
        e.target.id === "gst_percent"
    ) {
        calculateTotal();
    }
});

document.getElementById("add-row").addEventListener("click", function() {
    const row = document.querySelector(".item-row").cloneNode(true);
    row.querySelectorAll("input").forEach(i => i.value = "");
    document.getElementById("items-body").appendChild(row);
});

document.addEventListener("click", function(e){
    if(e.target.classList.contains("remove-row")){
        const rows = document.querySelectorAll(".item-row");
        if(rows.length > 1){
            e.target.closest("tr").remove();
            calculateTotal();
        }
    }
});

window.onload = function() {
    calculateTotal();
};

</script>

{% endblock %}