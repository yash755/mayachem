{% extends 'base.html' %}
{% block content %}
<h3>{{ 'Edit Sale' if sale else 'New Sale' }}</h3>

<form method="post" id="sale-form" class="row g-3">
  <!-- Date -->
  <div class="col-md-3">
    <label class="form-label">Date</label>
    <input type="date" name="date" class="form-control"
           value="{{ sale.date if sale else '' }}" required>
  </div>

  <!-- Sale Type -->
  <div class="col-md-3">
    <label class="form-label">Sale Type</label>
    <select name="sale_type" id="sale_type" class="form-select">
      <option value="bill" {% if sale_type == 'bill' %}selected{% endif %}>Bill</option>
      <option value="cash" {% if sale_type == 'cash' %}selected{% endif %}>Cash (bottles)</option>
    </select>
  </div>

  <!-- Client -->
  <div class="col-md-6">
    <label class="form-label">Client</label>
    <div class="d-flex gap-2">
      <select name="client_id" id="client_id" class="form-select">
        <option value="" {% if not sale %}selected{% endif %}>(choose client)</option>
        {% for c in clients %}
          <option value="{{ c.id }}" {% if sale and sale.client_name == c.name %}selected{% endif %}>{{ c.name }}</option>
        {% endfor %}
      </select>
      <input type="text" name="client_name" id="client_name" class="form-control"
             placeholder="Or type client name"
             value="{{ sale.client_name if sale else '' }}">
    </div>
    <div class="form-text">If both chosen, the dropdown wins.</div>
  </div>

  <!-- Hidden template select used by JS when creating cash rows -->
  <div style="display:none;">
    <select class="form-select bottle-type-select">
      <option value="">(choose)</option>
      {% for bt in bottle_types %}
        <option value="{{ bt.id }}"
                data-cp="{{ '%.2f'|format(bt.cp_per_batch()) }}"
                data-sp="{{ '%.2f'|format(bt.sp_per_batch()) }}">
          {{ bt.label }} ({{ bt.bottles_in_batch }} per batch)
        </option>
      {% endfor %}
    </select>
  </div>

  <!-- BILL MODE -->
  <div id="bill-mode" style="display:none;" class="col-12">
    <label class="form-label">Line Items (Bill)</label>
    <div class="table-responsive">
<table class="table table-sm" id="items-table-bill">
      <thead>
        <tr><th>Qty</th><th>Unit</th><th>Cost ₹/kg</th><th>Sell ₹/kg</th><th></th></tr>
      </thead>
      <tbody id="items-body-bill">
        {% if sale and sale.items and sale_type == 'bill' %}
          {% for item in sale.items %}
          <tr class="item-row">
            <td><input name="quantity[]" class="form-control"
                       value="{{ '%.2f'|format(item.quantity_kg) }}" required></td>
            <td>
              <select name="unit[]" class="form-select">
                <option value="kg" selected>kg</option>
                <option value="ton">ton</option>
              </select>
            </td>
            <td><input name="cost_rate[]" class="form-control"
                       value="{{ '%.2f'|format(item.cost_rate_per_kg) }}" required></td>
            <td><input name="sell_rate[]" class="form-control"
                       value="{{ '%.2f'|format(item.selling_rate_per_kg) }}" required></td>
            <td><button type="button" class="btn btn-sm btn-danger remove-row">−</button></td>
          </tr>
          {% endfor %}
        {% else %}
          <tr class="item-row">
            <td><input name="quantity[]" class="form-control" required></td>
            <td>
              <select name="unit[]" class="form-select">
                <option value="kg">kg</option>
                <option value="ton">ton</option>
              </select>
            </td>
            <td><input name="cost_rate[]" class="form-control" required></td>
            <td><input name="sell_rate[]" class="form-control" required></td>
            <td><button type="button" class="btn btn-sm btn-danger remove-row">−</button></td>
          </tr>
        {% endif %}
      </tbody>
    </table>
</div>
    <button type="button" id="add-row-bill" class="btn btn-outline-primary btn-sm">Add row</button>
  </div>

  <!-- CASH MODE -->
  <div id="cash-mode" style="display:none;" class="col-12">
    <label class="form-label">Bottle Lines (Cash)</label>
    <div class="table-responsive">
<table class="table table-sm" id="items-table-cash">
      <thead>
        <tr><th>Bottle Type</th><th>Batches</th><th>CP / batch (₹)</th><th>SP / batch (₹)</th><th></th></tr>
      </thead>
      <tbody id="items-body-cash">
        {% if sale and sale.items and sale_type == 'cash' %}
          {% for item in sale.items %}
          <tr class="cash-row">
            <td>
              <select name="bottle_type_id[]" class="form-select bottle-type-select">
                <option value="">(choose)</option>
                {% for bt in bottle_types %}
                  {% set selected = '' %}
                  {% if item.bottle_type_id and bt.id == item.bottle_type_id %}
                    {% set selected = 'selected' %}
                  {% elif ('%.2f'|format(bt.cp_per_batch()) == '%.2f'|format(item.cost_rate_per_kg))
                        and ('%.2f'|format(bt.sp_per_batch()) == '%.2f'|format(item.selling_rate_per_kg)) %}
                    {% set selected = 'selected' %}
                  {% endif %}
                  <option value="{{ bt.id }}"
                          data-cp="{{ '%.2f'|format(bt.cp_per_batch()) }}"
                          data-sp="{{ '%.2f'|format(bt.sp_per_batch()) }}"
                          {{ selected }}>
                    {{ bt.label }} ({{ bt.bottles_in_batch }} per batch)
                  </option>
                {% endfor %}
              </select>
            </td>

            <td><input name="batches[]" class="form-control"
                       value="{{ item.quantity_kg|int }}" required></td>

            <td><input class="form-control cp-per-batch" readonly
                       value="{{ '%.2f'|format(item.cost_rate_per_kg) }}"></td>

            <td>
              <!-- editable SP and hidden original_sp for preservation/submit -->
              <input class="form-control sp-per-batch" name="sp_batch[]" value="{{ '%.2f'|format(item.selling_rate_per_kg) }}">
              <input type="hidden" name="original_sp[]" class="original-sp" value="{{ '%.2f'|format(item.selling_rate_per_kg) }}">
            </td>

            <td><button type="button" class="btn btn-sm btn-danger remove-cash-row">−</button></td>
          </tr>
          {% endfor %}
        {% else %}
          <tr class="cash-row">
            <td>
              <select name="bottle_type_id[]" class="form-select bottle-type-select">
                <option value="">(choose)</option>
                {% for bt in bottle_types %}
                  <option value="{{ bt.id }}"
                          data-cp="{{ '%.2f'|format(bt.cp_per_batch()) }}"
                          data-sp="{{ '%.2f'|format(bt.sp_per_batch()) }}">
                    {{ bt.label }} ({{ bt.bottles_in_batch }} per batch)
                  </option>
                {% endfor %}
              </select>
            </td>
            <td><input name="batches[]" class="form-control" value="1" required></td>
            <td><input class="form-control cp-per-batch" readonly></td>
            <td>
              <input class="form-control sp-per-batch" name="sp_batch[]">
              <input type="hidden" name="original_sp[]" class="original-sp" value="">
            </td>
            <td><button type="button" class="btn btn-sm btn-danger remove-cash-row">−</button></td>
          </tr>
        {% endif %}
      </tbody>
    </table>
</div>
    <button type="button" id="add-row-cash" class="btn btn-outline-primary btn-sm">Add bottle row</button>
  </div>

  <!-- Totals -->
  <div class="col-md-3">
    <label class="form-label">Freight (₹)</label>
    <input type="number" step="0.01" min="0" name="freight" id="freight" class="form-control"
           value="{{ sale.freight if sale else 0 }}" required>
  </div>

  <div class="col-md-3">
    <label class="form-label">Total CP (auto)</label>
    <input type="text" id="total_cp" class="form-control" readonly>
  </div>

  <div class="col-md-3">
    <label class="form-label">Total SP (auto)</label>
    <input type="text" id="total_sp" class="form-control" readonly>
  </div>

  <div class="col-md-3">
    <label class="form-label">P / L (auto)</label>
    <input type="text" id="pl" class="form-control" readonly>
  </div>

  <!-- Actions -->
  <div class="col-12">
    <button class="btn btn-primary">Save</button>
    <a class="btn btn-secondary" href="{{ url_for('sales_list') }}">Cancel</a>
  </div>
</form>

<script src="{{ url_for('static', filename='sales.js') }}"></script>
{% endblock %}
